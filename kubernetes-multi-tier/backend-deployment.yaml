apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend-api
  template:
    metadata:
      labels:
        app: backend-api
    spec:
      containers:
      - name: backend-api
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          pip install flask psycopg2-binary
          mkdir -p /app
          cat > /app/api.py << 'EOF'
          from flask import Flask, jsonify
          import psycopg2
          
          app = Flask(__name__)
          
          def get_db_connection():
              conn = psycopg2.connect(
                  host='postgres',
                  database='employeedb',
                  user='admin',
                  password='securepassword123'
              )
              return conn
          
          @app.route('/api/health')
          def health():
              return jsonify({"status": "healthy", "service": "backend-api"})
          
          @app.route('/api/employees')
          def employees():
              try:
                  conn = get_db_connection()
                  cur = conn.cursor()
                  
                  cur.execute('''
                      CREATE TABLE IF NOT EXISTS employees (
                          id SERIAL PRIMARY KEY,
                          name VARCHAR(100),
                          department VARCHAR(100),
                          position VARCHAR(100)
                      )
                  ''')
                  
                  cur.execute('SELECT COUNT(*) FROM employees')
                  if cur.fetchone()[0] == 0:
                      sample_data = [
                          ('Brady Durham', 'Cloud Engineering', 'DevOps Engineer'),
                          ('Phillip Shepherd', 'Engineering', 'Software Dev Manager'),
                          ('Scott Jernigan', 'Cloud Engineering', 'Team Lead'),
                          ('Gabe Jahn', 'Technology', 'VP of Technology')
                      ]
                      cur.executemany(
                          'INSERT INTO employees (name, department, position) VALUES (%s, %s, %s)',
                          sample_data
                      )
                      conn.commit()
                  
                  cur.execute('SELECT id, name, department, position FROM employees')
                  employees = []
                  for row in cur.fetchall():
                      employees.append({
                          'id': row[0],
                          'name': row[1],
                          'department': row[2],
                          'position': row[3]
                      })
                  
                  cur.close()
                  conn.close()
                  return jsonify(employees)
              except Exception as e:
                  return jsonify({"error": str(e)}), 500
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=5000)
          EOF
          python /app/api.py
        ports:
        - containerPort: 5000
---
apiVersion: v1
kind: Service
metadata:
  name: backend-api
spec:
  type: NodePort
  selector:
    app: backend-api
  ports:
  - port: 5000
    targetPort: 5000
    nodePort: 30000
